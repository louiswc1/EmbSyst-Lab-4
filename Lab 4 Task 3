//=====[Libraries]=============================================================

#include "mbed.h"
#include "arm_book_lib.h"

//=====[Defines]===============================================================

#define NUMBER_OF_KEYS 4

#define OVER_TEMP_LEVEL 50

//=====[Declaration and initialization of public global objects]===============

DigitalIn enterButton(BUTTON1);
DigitalIn mq2(PE_12);

DigitalOut alarmLed(LED1);

UnbufferedSerial uartUsb(USBTX, USBRX, 115200);

AnalogIn potentiometer(A0);
AnalogIn lm35(A1);

//=====[Declaration and initialization of public global variables]=============

//keeps track of whether gas is detected or not
bool gasDetectorState = OFF;

//store the latest readings from the potentiometer and temperature sensor
float potentiometerReading = 0.0;
float lm35TempC = 0.0;

float analogReadingScaledWithTheLM35Formula(float analogReading);
void sendFloat(UnbufferedSerial &uart, float value);
void sendMessage();

//=====[Main function]=========================================================

int main()
{
    while (true) {
        //reads temperature sensor and scale it to degrees Celsius
        lm35TempC = analogReadingScaledWithTheLM35Formula(lm35.read());
        
        //reads potentiometer
        potentiometerReading = potentiometer.read();
        
        //check if gas is detected
        gasDetectorState = !mq2;

        //send all the sensor readings to serial terminal
        sendMessage();

        //1 second delay
        ThisThread::sleep_for(1s);
    }
}

//=====[Function Implementations]==============================================

float analogReadingScaledWithTheLM35Formula(float analogReading)
{
    return (analogReading * 3.3 / 0.01);
}

//function to send the float value as a text string
void sendFloat(UnbufferedSerial &uart, float value)
{
    char buffer[10];
    int intPart = (int)value;                      
    int decimalPart = (int)((value - intPart) * 100); 
    sprintf(buffer, "%d.%02d", intPart, abs(decimalPart)); 
    uart.write(buffer, strlen(buffer));
}


void sendMessage()
{
    uartUsb.write("The temperature is ", 20);
    sendFloat(uartUsb, lm35TempC);
    uartUsb.write(" Â°C, potentiometer reading ", 28);
    sendFloat(uartUsb, potentiometerReading);
    uartUsb.write(", Gas: ", 7);

    //gas detection status
    if (gasDetectorState) {
        uartUsb.write("Gas detected!\r\n", 15);
    } else {
        uartUsb.write("No gas detected.\r\n", 18);
    }
}
